<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>tango.io.FileConduit</title>
  <link href="html.css" rel="stylesheet" type="text/css">
</head>
<body>
<table><tr>
<td class="linescolumn"><a id="L1" href="#L1">1</a><a id="L2" href="#L2">2</a><a id="L3" href="#L3">3</a><a id="L4" href="#L4">4</a><a id="L5" href="#L5">5</a><a id="L6" href="#L6">6</a><a id="L7" href="#L7">7</a><a id="L8" href="#L8">8</a><a id="L9" href="#L9">9</a><a id="L10" href="#L10">10</a><a id="L11" href="#L11">11</a><a id="L12" href="#L12">12</a><a id="L13" href="#L13">13</a><a id="L14" href="#L14">14</a><a id="L15" href="#L15">15</a><a id="L16" href="#L16">16</a><a id="L17" href="#L17">17</a><a id="L18" href="#L18">18</a><a id="L19" href="#L19">19</a><a id="L20" href="#L20">20</a><a id="L21" href="#L21">21</a><a id="L22" href="#L22">22</a><a id="L23" href="#L23">23</a><a id="L24" href="#L24">24</a><a id="L25" href="#L25">25</a><a id="L26" href="#L26">26</a><a id="L27" href="#L27">27</a><a id="L28" href="#L28">28</a><a id="L29" href="#L29">29</a><a id="L30" href="#L30">30</a><a id="L31" href="#L31">31</a><a id="L32" href="#L32">32</a><a id="L33" href="#L33">33</a><a id="L34" href="#L34">34</a><a id="L35" href="#L35">35</a><a id="L36" href="#L36">36</a><a id="L37" href="#L37">37</a><a id="L38" href="#L38">38</a><a id="L39" href="#L39">39</a><a id="L40" href="#L40">40</a><a id="L41" href="#L41">41</a><a id="L42" href="#L42">42</a><a id="L43" href="#L43">43</a><a id="L44" href="#L44">44</a><a id="L45" href="#L45">45</a><a id="L46" href="#L46">46</a><a id="L47" href="#L47">47</a><a id="L48" href="#L48">48</a><a id="L49" href="#L49">49</a><a id="L50" href="#L50">50</a><a id="L51" href="#L51">51</a><a id="L52" href="#L52">52</a><a id="L53" href="#L53">53</a><a id="L54" href="#L54">54</a><a id="L55" href="#L55">55</a><a id="L56" href="#L56">56</a><a id="L57" href="#L57">57</a><a id="L58" href="#L58">58</a><a id="L59" href="#L59">59</a><a id="L60" href="#L60">60</a><a id="L61" href="#L61">61</a><a id="L62" href="#L62">62</a><a id="L63" href="#L63">63</a><a id="L64" href="#L64">64</a><a id="L65" href="#L65">65</a><a id="L66" href="#L66">66</a><a id="L67" href="#L67">67</a><a id="L68" href="#L68">68</a><a id="L69" href="#L69">69</a><a id="L70" href="#L70">70</a><a id="L71" href="#L71">71</a><a id="L72" href="#L72">72</a><a id="L73" href="#L73">73</a><a id="L74" href="#L74">74</a><a id="L75" href="#L75">75</a><a id="L76" href="#L76">76</a><a id="L77" href="#L77">77</a><a id="L78" href="#L78">78</a><a id="L79" href="#L79">79</a><a id="L80" href="#L80">80</a><a id="L81" href="#L81">81</a><a id="L82" href="#L82">82</a><a id="L83" href="#L83">83</a><a id="L84" href="#L84">84</a><a id="L85" href="#L85">85</a><a id="L86" href="#L86">86</a><a id="L87" href="#L87">87</a><a id="L88" href="#L88">88</a><a id="L89" href="#L89">89</a><a id="L90" href="#L90">90</a><a id="L91" href="#L91">91</a><a id="L92" href="#L92">92</a><a id="L93" href="#L93">93</a><a id="L94" href="#L94">94</a><a id="L95" href="#L95">95</a><a id="L96" href="#L96">96</a><a id="L97" href="#L97">97</a><a id="L98" href="#L98">98</a><a id="L99" href="#L99">99</a><a id="L100" href="#L100">100</a><a id="L101" href="#L101">101</a><a id="L102" href="#L102">102</a><a id="L103" href="#L103">103</a><a id="L104" href="#L104">104</a><a id="L105" href="#L105">105</a><a id="L106" href="#L106">106</a><a id="L107" href="#L107">107</a><a id="L108" href="#L108">108</a><a id="L109" href="#L109">109</a><a id="L110" href="#L110">110</a><a id="L111" href="#L111">111</a><a id="L112" href="#L112">112</a><a id="L113" href="#L113">113</a><a id="L114" href="#L114">114</a><a id="L115" href="#L115">115</a><a id="L116" href="#L116">116</a><a id="L117" href="#L117">117</a><a id="L118" href="#L118">118</a><a id="L119" href="#L119">119</a><a id="L120" href="#L120">120</a><a id="L121" href="#L121">121</a><a id="L122" href="#L122">122</a><a id="L123" href="#L123">123</a><a id="L124" href="#L124">124</a><a id="L125" href="#L125">125</a><a id="L126" href="#L126">126</a><a id="L127" href="#L127">127</a><a id="L128" href="#L128">128</a><a id="L129" href="#L129">129</a><a id="L130" href="#L130">130</a><a id="L131" href="#L131">131</a><a id="L132" href="#L132">132</a><a id="L133" href="#L133">133</a><a id="L134" href="#L134">134</a><a id="L135" href="#L135">135</a><a id="L136" href="#L136">136</a><a id="L137" href="#L137">137</a><a id="L138" href="#L138">138</a><a id="L139" href="#L139">139</a><a id="L140" href="#L140">140</a><a id="L141" href="#L141">141</a><a id="L142" href="#L142">142</a><a id="L143" href="#L143">143</a><a id="L144" href="#L144">144</a><a id="L145" href="#L145">145</a><a id="L146" href="#L146">146</a><a id="L147" href="#L147">147</a><a id="L148" href="#L148">148</a><a id="L149" href="#L149">149</a><a id="L150" href="#L150">150</a><a id="L151" href="#L151">151</a><a id="L152" href="#L152">152</a><a id="L153" href="#L153">153</a><a id="L154" href="#L154">154</a><a id="L155" href="#L155">155</a><a id="L156" href="#L156">156</a><a id="L157" href="#L157">157</a><a id="L158" href="#L158">158</a><a id="L159" href="#L159">159</a><a id="L160" href="#L160">160</a><a id="L161" href="#L161">161</a><a id="L162" href="#L162">162</a><a id="L163" href="#L163">163</a><a id="L164" href="#L164">164</a><a id="L165" href="#L165">165</a><a id="L166" href="#L166">166</a><a id="L167" href="#L167">167</a><a id="L168" href="#L168">168</a><a id="L169" href="#L169">169</a><a id="L170" href="#L170">170</a><a id="L171" href="#L171">171</a><a id="L172" href="#L172">172</a><a id="L173" href="#L173">173</a><a id="L174" href="#L174">174</a><a id="L175" href="#L175">175</a><a id="L176" href="#L176">176</a><a id="L177" href="#L177">177</a><a id="L178" href="#L178">178</a><a id="L179" href="#L179">179</a><a id="L180" href="#L180">180</a><a id="L181" href="#L181">181</a><a id="L182" href="#L182">182</a><a id="L183" href="#L183">183</a><a id="L184" href="#L184">184</a><a id="L185" href="#L185">185</a><a id="L186" href="#L186">186</a><a id="L187" href="#L187">187</a><a id="L188" href="#L188">188</a><a id="L189" href="#L189">189</a><a id="L190" href="#L190">190</a><a id="L191" href="#L191">191</a><a id="L192" href="#L192">192</a><a id="L193" href="#L193">193</a><a id="L194" href="#L194">194</a><a id="L195" href="#L195">195</a><a id="L196" href="#L196">196</a><a id="L197" href="#L197">197</a><a id="L198" href="#L198">198</a><a id="L199" href="#L199">199</a><a id="L200" href="#L200">200</a><a id="L201" href="#L201">201</a><a id="L202" href="#L202">202</a><a id="L203" href="#L203">203</a><a id="L204" href="#L204">204</a><a id="L205" href="#L205">205</a><a id="L206" href="#L206">206</a><a id="L207" href="#L207">207</a><a id="L208" href="#L208">208</a><a id="L209" href="#L209">209</a><a id="L210" href="#L210">210</a><a id="L211" href="#L211">211</a><a id="L212" href="#L212">212</a><a id="L213" href="#L213">213</a><a id="L214" href="#L214">214</a><a id="L215" href="#L215">215</a><a id="L216" href="#L216">216</a><a id="L217" href="#L217">217</a><a id="L218" href="#L218">218</a><a id="L219" href="#L219">219</a><a id="L220" href="#L220">220</a><a id="L221" href="#L221">221</a><a id="L222" href="#L222">222</a><a id="L223" href="#L223">223</a><a id="L224" href="#L224">224</a><a id="L225" href="#L225">225</a><a id="L226" href="#L226">226</a><a id="L227" href="#L227">227</a><a id="L228" href="#L228">228</a><a id="L229" href="#L229">229</a><a id="L230" href="#L230">230</a><a id="L231" href="#L231">231</a><a id="L232" href="#L232">232</a><a id="L233" href="#L233">233</a><a id="L234" href="#L234">234</a><a id="L235" href="#L235">235</a><a id="L236" href="#L236">236</a><a id="L237" href="#L237">237</a><a id="L238" href="#L238">238</a><a id="L239" href="#L239">239</a><a id="L240" href="#L240">240</a><a id="L241" href="#L241">241</a><a id="L242" href="#L242">242</a><a id="L243" href="#L243">243</a><a id="L244" href="#L244">244</a><a id="L245" href="#L245">245</a><a id="L246" href="#L246">246</a><a id="L247" href="#L247">247</a><a id="L248" href="#L248">248</a><a id="L249" href="#L249">249</a><a id="L250" href="#L250">250</a><a id="L251" href="#L251">251</a><a id="L252" href="#L252">252</a><a id="L253" href="#L253">253</a><a id="L254" href="#L254">254</a><a id="L255" href="#L255">255</a><a id="L256" href="#L256">256</a><a id="L257" href="#L257">257</a><a id="L258" href="#L258">258</a><a id="L259" href="#L259">259</a><a id="L260" href="#L260">260</a><a id="L261" href="#L261">261</a><a id="L262" href="#L262">262</a><a id="L263" href="#L263">263</a><a id="L264" href="#L264">264</a><a id="L265" href="#L265">265</a><a id="L266" href="#L266">266</a><a id="L267" href="#L267">267</a><a id="L268" href="#L268">268</a><a id="L269" href="#L269">269</a><a id="L270" href="#L270">270</a><a id="L271" href="#L271">271</a><a id="L272" href="#L272">272</a><a id="L273" href="#L273">273</a><a id="L274" href="#L274">274</a><a id="L275" href="#L275">275</a><a id="L276" href="#L276">276</a><a id="L277" href="#L277">277</a><a id="L278" href="#L278">278</a><a id="L279" href="#L279">279</a><a id="L280" href="#L280">280</a><a id="L281" href="#L281">281</a><a id="L282" href="#L282">282</a><a id="L283" href="#L283">283</a><a id="L284" href="#L284">284</a><a id="L285" href="#L285">285</a><a id="L286" href="#L286">286</a><a id="L287" href="#L287">287</a><a id="L288" href="#L288">288</a><a id="L289" href="#L289">289</a><a id="L290" href="#L290">290</a><a id="L291" href="#L291">291</a><a id="L292" href="#L292">292</a><a id="L293" href="#L293">293</a><a id="L294" href="#L294">294</a><a id="L295" href="#L295">295</a><a id="L296" href="#L296">296</a><a id="L297" href="#L297">297</a><a id="L298" href="#L298">298</a><a id="L299" href="#L299">299</a><a id="L300" href="#L300">300</a><a id="L301" href="#L301">301</a><a id="L302" href="#L302">302</a><a id="L303" href="#L303">303</a><a id="L304" href="#L304">304</a><a id="L305" href="#L305">305</a><a id="L306" href="#L306">306</a><a id="L307" href="#L307">307</a><a id="L308" href="#L308">308</a><a id="L309" href="#L309">309</a><a id="L310" href="#L310">310</a><a id="L311" href="#L311">311</a><a id="L312" href="#L312">312</a><a id="L313" href="#L313">313</a><a id="L314" href="#L314">314</a><a id="L315" href="#L315">315</a><a id="L316" href="#L316">316</a><a id="L317" href="#L317">317</a><a id="L318" href="#L318">318</a><a id="L319" href="#L319">319</a><a id="L320" href="#L320">320</a><a id="L321" href="#L321">321</a><a id="L322" href="#L322">322</a><a id="L323" href="#L323">323</a><a id="L324" href="#L324">324</a><a id="L325" href="#L325">325</a><a id="L326" href="#L326">326</a><a id="L327" href="#L327">327</a><a id="L328" href="#L328">328</a><a id="L329" href="#L329">329</a><a id="L330" href="#L330">330</a><a id="L331" href="#L331">331</a><a id="L332" href="#L332">332</a><a id="L333" href="#L333">333</a><a id="L334" href="#L334">334</a><a id="L335" href="#L335">335</a><a id="L336" href="#L336">336</a><a id="L337" href="#L337">337</a><a id="L338" href="#L338">338</a><a id="L339" href="#L339">339</a><a id="L340" href="#L340">340</a><a id="L341" href="#L341">341</a><a id="L342" href="#L342">342</a><a id="L343" href="#L343">343</a><a id="L344" href="#L344">344</a><a id="L345" href="#L345">345</a><a id="L346" href="#L346">346</a><a id="L347" href="#L347">347</a><a id="L348" href="#L348">348</a><a id="L349" href="#L349">349</a><a id="L350" href="#L350">350</a><a id="L351" href="#L351">351</a><a id="L352" href="#L352">352</a><a id="L353" href="#L353">353</a><a id="L354" href="#L354">354</a><a id="L355" href="#L355">355</a><a id="L356" href="#L356">356</a><a id="L357" href="#L357">357</a><a id="L358" href="#L358">358</a><a id="L359" href="#L359">359</a><a id="L360" href="#L360">360</a><a id="L361" href="#L361">361</a><a id="L362" href="#L362">362</a><a id="L363" href="#L363">363</a><a id="L364" href="#L364">364</a><a id="L365" href="#L365">365</a><a id="L366" href="#L366">366</a><a id="L367" href="#L367">367</a><a id="L368" href="#L368">368</a><a id="L369" href="#L369">369</a><a id="L370" href="#L370">370</a><a id="L371" href="#L371">371</a><a id="L372" href="#L372">372</a><a id="L373" href="#L373">373</a><a id="L374" href="#L374">374</a><a id="L375" href="#L375">375</a><a id="L376" href="#L376">376</a><a id="L377" href="#L377">377</a><a id="L378" href="#L378">378</a><a id="L379" href="#L379">379</a><a id="L380" href="#L380">380</a><a id="L381" href="#L381">381</a><a id="L382" href="#L382">382</a><a id="L383" href="#L383">383</a><a id="L384" href="#L384">384</a><a id="L385" href="#L385">385</a><a id="L386" href="#L386">386</a><a id="L387" href="#L387">387</a><a id="L388" href="#L388">388</a><a id="L389" href="#L389">389</a><a id="L390" href="#L390">390</a><a id="L391" href="#L391">391</a><a id="L392" href="#L392">392</a><a id="L393" href="#L393">393</a><a id="L394" href="#L394">394</a><a id="L395" href="#L395">395</a><a id="L396" href="#L396">396</a><a id="L397" href="#L397">397</a><a id="L398" href="#L398">398</a><a id="L399" href="#L399">399</a><a id="L400" href="#L400">400</a><a id="L401" href="#L401">401</a><a id="L402" href="#L402">402</a><a id="L403" href="#L403">403</a><a id="L404" href="#L404">404</a><a id="L405" href="#L405">405</a><a id="L406" href="#L406">406</a><a id="L407" href="#L407">407</a><a id="L408" href="#L408">408</a><a id="L409" href="#L409">409</a><a id="L410" href="#L410">410</a><a id="L411" href="#L411">411</a><a id="L412" href="#L412">412</a><a id="L413" href="#L413">413</a><a id="L414" href="#L414">414</a><a id="L415" href="#L415">415</a><a id="L416" href="#L416">416</a><a id="L417" href="#L417">417</a><a id="L418" href="#L418">418</a><a id="L419" href="#L419">419</a><a id="L420" href="#L420">420</a><a id="L421" href="#L421">421</a><a id="L422" href="#L422">422</a><a id="L423" href="#L423">423</a><a id="L424" href="#L424">424</a><a id="L425" href="#L425">425</a><a id="L426" href="#L426">426</a><a id="L427" href="#L427">427</a><a id="L428" href="#L428">428</a><a id="L429" href="#L429">429</a><a id="L430" href="#L430">430</a><a id="L431" href="#L431">431</a><a id="L432" href="#L432">432</a><a id="L433" href="#L433">433</a><a id="L434" href="#L434">434</a><a id="L435" href="#L435">435</a><a id="L436" href="#L436">436</a><a id="L437" href="#L437">437</a><a id="L438" href="#L438">438</a><a id="L439" href="#L439">439</a><a id="L440" href="#L440">440</a><a id="L441" href="#L441">441</a><a id="L442" href="#L442">442</a><a id="L443" href="#L443">443</a><a id="L444" href="#L444">444</a><a id="L445" href="#L445">445</a><a id="L446" href="#L446">446</a><a id="L447" href="#L447">447</a><a id="L448" href="#L448">448</a><a id="L449" href="#L449">449</a><a id="L450" href="#L450">450</a><a id="L451" href="#L451">451</a><a id="L452" href="#L452">452</a><a id="L453" href="#L453">453</a><a id="L454" href="#L454">454</a><a id="L455" href="#L455">455</a><a id="L456" href="#L456">456</a><a id="L457" href="#L457">457</a><a id="L458" href="#L458">458</a><a id="L459" href="#L459">459</a><a id="L460" href="#L460">460</a><a id="L461" href="#L461">461</a><a id="L462" href="#L462">462</a><a id="L463" href="#L463">463</a><a id="L464" href="#L464">464</a><a id="L465" href="#L465">465</a><a id="L466" href="#L466">466</a><a id="L467" href="#L467">467</a><a id="L468" href="#L468">468</a><a id="L469" href="#L469">469</a><a id="L470" href="#L470">470</a><a id="L471" href="#L471">471</a><a id="L472" href="#L472">472</a><a id="L473" href="#L473">473</a><a id="L474" href="#L474">474</a><a id="L475" href="#L475">475</a><a id="L476" href="#L476">476</a><a id="L477" href="#L477">477</a><a id="L478" href="#L478">478</a><a id="L479" href="#L479">479</a><a id="L480" href="#L480">480</a><a id="L481" href="#L481">481</a><a id="L482" href="#L482">482</a><a id="L483" href="#L483">483</a><a id="L484" href="#L484">484</a><a id="L485" href="#L485">485</a><a id="L486" href="#L486">486</a><a id="L487" href="#L487">487</a><a id="L488" href="#L488">488</a><a id="L489" href="#L489">489</a><a id="L490" href="#L490">490</a><a id="L491" href="#L491">491</a><a id="L492" href="#L492">492</a><a id="L493" href="#L493">493</a><a id="L494" href="#L494">494</a><a id="L495" href="#L495">495</a><a id="L496" href="#L496">496</a><a id="L497" href="#L497">497</a><a id="L498" href="#L498">498</a><a id="L499" href="#L499">499</a><a id="L500" href="#L500">500</a><a id="L501" href="#L501">501</a><a id="L502" href="#L502">502</a><a id="L503" href="#L503">503</a><a id="L504" href="#L504">504</a><a id="L505" href="#L505">505</a><a id="L506" href="#L506">506</a><a id="L507" href="#L507">507</a><a id="L508" href="#L508">508</a><a id="L509" href="#L509">509</a><a id="L510" href="#L510">510</a><a id="L511" href="#L511">511</a><a id="L512" href="#L512">512</a><a id="L513" href="#L513">513</a><a id="L514" href="#L514">514</a><a id="L515" href="#L515">515</a><a id="L516" href="#L516">516</a><a id="L517" href="#L517">517</a><a id="L518" href="#L518">518</a><a id="L519" href="#L519">519</a><a id="L520" href="#L520">520</a><a id="L521" href="#L521">521</a><a id="L522" href="#L522">522</a><a id="L523" href="#L523">523</a><a id="L524" href="#L524">524</a><a id="L525" href="#L525">525</a><a id="L526" href="#L526">526</a><a id="L527" href="#L527">527</a><a id="L528" href="#L528">528</a><a id="L529" href="#L529">529</a><a id="L530" href="#L530">530</a><a id="L531" href="#L531">531</a><a id="L532" href="#L532">532</a><a id="L533" href="#L533">533</a><a id="L534" href="#L534">534</a><a id="L535" href="#L535">535</a><a id="L536" href="#L536">536</a><a id="L537" href="#L537">537</a><a id="L538" href="#L538">538</a><a id="L539" href="#L539">539</a><a id="L540" href="#L540">540</a><a id="L541" href="#L541">541</a><a id="L542" href="#L542">542</a><a id="L543" href="#L543">543</a><a id="L544" href="#L544">544</a><a id="L545" href="#L545">545</a><a id="L546" href="#L546">546</a><a id="L547" href="#L547">547</a><a id="L548" href="#L548">548</a><a id="L549" href="#L549">549</a><a id="L550" href="#L550">550</a><a id="L551" href="#L551">551</a><a id="L552" href="#L552">552</a><a id="L553" href="#L553">553</a><a id="L554" href="#L554">554</a><a id="L555" href="#L555">555</a><a id="L556" href="#L556">556</a><a id="L557" href="#L557">557</a><a id="L558" href="#L558">558</a><a id="L559" href="#L559">559</a><a id="L560" href="#L560">560</a><a id="L561" href="#L561">561</a><a id="L562" href="#L562">562</a><a id="L563" href="#L563">563</a><a id="L564" href="#L564">564</a><a id="L565" href="#L565">565</a><a id="L566" href="#L566">566</a><a id="L567" href="#L567">567</a><a id="L568" href="#L568">568</a><a id="L569" href="#L569">569</a><a id="L570" href="#L570">570</a><a id="L571" href="#L571">571</a><a id="L572" href="#L572">572</a><a id="L573" href="#L573">573</a><a id="L574" href="#L574">574</a><a id="L575" href="#L575">575</a><a id="L576" href="#L576">576</a><a id="L577" href="#L577">577</a><a id="L578" href="#L578">578</a><a id="L579" href="#L579">579</a><a id="L580" href="#L580">580</a><a id="L581" href="#L581">581</a><a id="L582" href="#L582">582</a><a id="L583" href="#L583">583</a><a id="L584" href="#L584">584</a><a id="L585" href="#L585">585</a><a id="L586" href="#L586">586</a><a id="L587" href="#L587">587</a><a id="L588" href="#L588">588</a><a id="L589" href="#L589">589</a><a id="L590" href="#L590">590</a><a id="L591" href="#L591">591</a><a id="L592" href="#L592">592</a><a id="L593" href="#L593">593</a></td>
<td><td><pre class="sourcecode">
<span class="bc">/*******************************************************************************

        copyright:      Copyright (c) 2004 Kris Bell. All rights reserved

        license:        BSD style: $(LICENSE)

        version:        Initial release: March 2004      
                        Outback release: December 2006
                        
        author:         $(UL Kris)
                        $(UL John Reimer)
                        $(UL Anders F Bjorklund (Darwin patches))
                        $(UL Chris Sauls (Win95 file support))

*******************************************************************************/</span>

<span class="d Compound"><span class="d Module"><span class="k">module</span> <span class="i">tango</span>.<span class="i">io</span>.<span class="i">FileConduit</span>;</span>

<span class="d Protection"><span class="k">private</span> <span class="d Import"><span class="k">import</span>  <span class="i">tango</span>.<span class="i">sys</span>.<span class="i">Common</span>;</span></span>

<span class="d Protection"><span class="k">public</span>  <span class="d Import"><span class="k">import</span>  <span class="i">tango</span>.<span class="i">io</span>.<span class="i">FilePath</span>;</span></span>

<span class="d Protection"><span class="k">private</span> <span class="d Import"><span class="k">import</span>  <span class="i">tango</span>.<span class="i">io</span>.<span class="i">DeviceConduit</span>;</span></span>

<span class="d Protection"><span class="k">private</span> <span class="d Import"><span class="k">import</span>  <span class="i">stdc</span> = <span class="i">tango</span>.<span class="i">stdc</span>.<span class="i">stringz</span>;</span></span>

<span class="d Protection"><span class="k">private</span> <span class="d Import"><span class="k">import</span>  <span class="i">Utf</span> = <span class="i">tango</span>.<span class="i">text</span>.<span class="i">convert</span>.<span class="i">Utf</span>;</span></span>

<span class="bc">/*******************************************************************************

        Other O/S functions

*******************************************************************************/</span>

<span class="d Version"><span class="k">version</span> (<span class="i">Win32</span>)
         <span class="d Protection"><span class="k">private</span> <span class="d Linkage"><span class="k">extern</span> (<span class="i">Windows</span>) <span class="d Function"><span class="t Identifier"><span class="i">BOOL</span></span> <span class="i">SetEndOfFile</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">HANDLE</span></span></span>)</span><span class="s FuncBody">;</span></span></span></span>
     <span class="k">else</span>
        <span class="d Protection"><span class="k">private</span> <span class="d Linkage"><span class="k">extern</span> (<span class="i">C</span>) <span class="d Function"><span class="t Integral"><span class="k">int</span></span> <span class="i">ftruncate</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">int</span></span></span>, <span class="o Parameter"><span class="t Integral"><span class="k">int</span></span></span>)</span><span class="s FuncBody">;</span></span></span></span></span>


<span class="bc">/*******************************************************************************

        Implements a means of reading and writing a generic file. Conduits
        are the primary means of accessing external data and FileConduit
        extends the basic pattern by providing file-specific methods to
        set the file size, seek to a specific file position and so on. 
        
        Serial input and output is straightforward. In this example we
        copy a file directly to the console:
        ---
        // open a file for reading
        auto from = new FileConduit ("test.txt");

        // stream directly to console
        Stdout.copy (from);
        ---

        And here we copy one file to another:
        ---
        // open another for writing
        auto to = new FileConduit ("copy.txt", FileConduit.WriteCreate);

        // copy file
        to.output.copy (new FileConduit("test.txt"));
        ---
        
        To load a file directly into memory one might do this:
        ---
        // open file for reading
        auto fc = new FileConduit ("test.txt");

        // create an array to house the entire file
        auto content = new char[fc.length];

        // read the file content. Return value is the number of bytes read
        auto bytesRead = fc.input.read (content);
        ---

        Conversely, one may write directly to a FileConduit, like so:
        ---
        // open file for writing
        auto to = new FileConduit ("text.txt", FileConduit.WriteCreate);

        // write an array of content to it
        auto bytesWritten = to.output.write (content);
        ---

        FileConduit can just as easily handle random IO. Here we use seek()
        to relocate the file pointer and, for variation, apply a protocol to
        perform simple input and output:
        ---
        // open a file for reading
        auto fc = new FileConduit ("random.bin", FileConduit.ReadWriteCreate);

        // construct (binary) reader &amp; writer upon this conduit
        auto read = new Reader (fc);
        auto write = new Writer (fc);

        int x=10, y=20;

        // write some data, and flush output since protocol IO is buffered
        write (x) (y) ();

        // rewind to file start
        fc.seek (0);

        // read data back again
        read (x) (y);

        fc.close();
        ---

        See File, FilePath, FileScan, and FileSystem for 
        additional functionality related to file manipulation. 

        Compile with -version=Win32SansUnicode to enable Win95 &amp; Win32s file 
        support.
        
*******************************************************************************/</span>

<span class="d Class"><span class="k">class</span> <span class="i">FileConduit</span> : <span class="t BaseClass"><span class="t Identifier"><span class="i">DeviceConduit</span></span></span>, <span class="t BaseClass"><span class="t Qualified"><span class="t Identifier"><span class="i">DeviceConduit</span></span>.<span class="t Identifier"><span class="i">Seek</span></span></span></span>
<span class="d Compound">{
        <span class="bc">/***********************************************************************
        
                Fits into 32 bits ...

        ***********************************************************************/</span>

        <span class="d Struct"><span class="k">struct</span> <span class="i">Style</span>
        <span class="d Compound">{
                <span class="d Align"><span class="k">align</span> (<span class="n">1</span>):

                <span class="d Compound"><span class="d Variables"><span class="t Identifier"><span class="i">Access</span></span>          <span class="i">access</span>;</span>                 <span class="lc">/// access rights</span>
                <span class="d Variables"><span class="t Identifier"><span class="i">Open</span></span>            <span class="i">open</span>;</span>                   <span class="lc">/// how to open</span>
                <span class="d Variables"><span class="t Identifier"><span class="i">Share</span></span>           <span class="i">share</span>;</span>                  <span class="lc">/// how to share</span>
                <span class="d Variables"><span class="t Identifier"><span class="i">Cache</span></span>           <span class="i">cache</span>;</span></span></span>                  <span class="lc">/// how to cache</span>
        }</span></span>

        <span class="bc">/***********************************************************************

        ***********************************************************************/</span>

        <span class="d Enum"><span class="k">enum</span> <span class="i">Access</span> : <span class="t Integral"><span class="k">ubyte</span></span>     {
                                <span class="d EnumMember"><span class="i">Read</span>      = <span class="e Int"><span class="n">0x01</span></span></span>,       <span class="lc">/// is readable</span>
                                <span class="d EnumMember"><span class="i">Write</span>     = <span class="e Int"><span class="n">0x02</span></span></span>,       <span class="lc">/// is writable</span>
                                <span class="d EnumMember"><span class="i">ReadWrite</span> = <span class="e Int"><span class="n">0x03</span></span></span>,       <span class="lc">/// both</span>
                                }</span>

        <span class="bc">/***********************************************************************
        
        ***********************************************************************/</span>

        <span class="d Enum"><span class="k">enum</span> <span class="i">Open</span> : <span class="t Integral"><span class="k">ubyte</span></span>       {
                                <span class="d EnumMember"><span class="i">Exists</span>=<span class="e Int"><span class="n">0</span></span></span>,               <span class="lc">/// must exist</span>
                                <span class="d EnumMember"><span class="i">Create</span></span>,                 <span class="lc">/// create or truncate</span>
                                <span class="d EnumMember"><span class="i">Sedate</span></span>,                 <span class="lc">/// create if necessary</span>
                                <span class="d EnumMember"><span class="i">Append</span></span>,                 <span class="lc">/// create if necessary</span>
                                }</span><span class="d Empty">;</span>

        <span class="bc">/***********************************************************************
        
        ***********************************************************************/</span>

        <span class="d Enum"><span class="k">enum</span> <span class="i">Share</span> : <span class="t Integral"><span class="k">ubyte</span></span>      {
                                <span class="d EnumMember"><span class="i">None</span>=<span class="e Int"><span class="n">0</span></span></span>,                 <span class="lc">/// no sharing</span>
                                <span class="d EnumMember"><span class="i">Read</span></span>,                   <span class="lc">/// shared reading</span>
                                <span class="d EnumMember"><span class="i">ReadWrite</span></span>,              <span class="lc">/// open for anything</span>
                                }</span><span class="d Empty">;</span>

        <span class="bc">/***********************************************************************
        
        ***********************************************************************/</span>

        <span class="d Enum"><span class="k">enum</span> <span class="i">Cache</span> : <span class="t Integral"><span class="k">ubyte</span></span>      {
                                <span class="d EnumMember"><span class="i">None</span>      = <span class="e Int"><span class="n">0x00</span></span></span>,       <span class="lc">/// don't optimize</span>
                                <span class="d EnumMember"><span class="i">Random</span>    = <span class="e Int"><span class="n">0x01</span></span></span>,       <span class="lc">/// optimize for random</span>
                                <span class="d EnumMember"><span class="i">Stream</span>    = <span class="e Int"><span class="n">0x02</span></span></span>,       <span class="lc">/// optimize for stream</span>
                                <span class="d EnumMember"><span class="i">WriteThru</span> = <span class="e Int"><span class="n">0x04</span></span></span>,       <span class="lc">/// backing-cache flag</span>
                                }</span><span class="d Empty">;</span>

        <span class="bc">/***********************************************************************

            Read an existing file
        
        ***********************************************************************/</span>

        <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">ReadExisting</span> = <span class="e StructInit">{<span class="e Dot"><span class="e Identifier"><span class="i">Access</span></span>.<span class="e Identifier"><span class="i">Read</span></span></span>, <span class="e Dot"><span class="e Identifier"><span class="i">Open</span></span>.<span class="e Identifier"><span class="i">Exists</span></span></span>}</span>;</span></span>

        <span class="bc">/***********************************************************************
        
                Write on an existing file. Do not create

        ***********************************************************************/</span>

        <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">WriteExisting</span> = <span class="e StructInit">{<span class="e Dot"><span class="e Identifier"><span class="i">Access</span></span>.<span class="e Identifier"><span class="i">Write</span></span></span>, <span class="e Dot"><span class="e Identifier"><span class="i">Open</span></span>.<span class="e Identifier"><span class="i">Exists</span></span></span>}</span>;</span></span>

        <span class="bc">/***********************************************************************
        
                Write on a clean file. Create if necessary

        ***********************************************************************/</span>

        <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">WriteCreate</span> = <span class="e StructInit">{<span class="e Dot"><span class="e Identifier"><span class="i">Access</span></span>.<span class="e Identifier"><span class="i">Write</span></span></span>, <span class="e Dot"><span class="e Identifier"><span class="i">Open</span></span>.<span class="e Identifier"><span class="i">Create</span></span></span>}</span>;</span></span>

        <span class="bc">/***********************************************************************
        
                Write at the end of the file

        ***********************************************************************/</span>

        <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">WriteAppending</span> = <span class="e StructInit">{<span class="e Dot"><span class="e Identifier"><span class="i">Access</span></span>.<span class="e Identifier"><span class="i">Write</span></span></span>, <span class="e Dot"><span class="e Identifier"><span class="i">Open</span></span>.<span class="e Identifier"><span class="i">Append</span></span></span>}</span>;</span></span>

        <span class="bc">/***********************************************************************
        
                Read and write an existing file

        ***********************************************************************/</span>

        <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">ReadWriteExisting</span> = <span class="e StructInit">{<span class="e Dot"><span class="e Identifier"><span class="i">Access</span></span>.<span class="e Identifier"><span class="i">ReadWrite</span></span></span>, <span class="e Dot"><span class="e Identifier"><span class="i">Open</span></span>.<span class="e Identifier"><span class="i">Exists</span></span></span>}</span>;</span></span> 

        <span class="bc">/***********************************************************************
        
                Read &amp; write on a clean file. Create if necessary

        ***********************************************************************/</span>

        <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">ReadWriteCreate</span> = <span class="e StructInit">{<span class="e Dot"><span class="e Identifier"><span class="i">Access</span></span>.<span class="e Identifier"><span class="i">ReadWrite</span></span></span>, <span class="e Dot"><span class="e Identifier"><span class="i">Open</span></span>.<span class="e Identifier"><span class="i">Create</span></span></span>}</span>;</span></span> 

        <span class="bc">/***********************************************************************
        
                Read and Write. Use existing file if present

        ***********************************************************************/</span>

        <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">ReadWriteOpen</span> = <span class="e StructInit">{<span class="e Dot"><span class="e Identifier"><span class="i">Access</span></span>.<span class="e Identifier"><span class="i">ReadWrite</span></span></span>, <span class="e Dot"><span class="e Identifier"><span class="i">Open</span></span>.<span class="e Identifier"><span class="i">Sedate</span></span></span>}</span>;</span></span> 




        <span class="lc">// the file we're working with </span>
        <span class="d Protection"><span class="k">private</span> <span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span>  <span class="i">path_</span>;</span></span>

        <span class="lc">// the style we're opened with</span>
        <span class="d Protection"><span class="k">private</span> <span class="d Variables"><span class="t Identifier"><span class="i">Style</span></span>   <span class="i">style_</span>;</span></span>

        <span class="bc">/***********************************************************************
        
                Create a FileConduit for use with open()

        ***********************************************************************/</span>

        <span class="d Constructor"><span class="k">this</span> <span class="o Parameters">()</span>
        <span class="s FuncBody"><span class="s Compound">{
        }</span></span></span>

        <span class="bc">/***********************************************************************
        
                Create a FileConduit with the provided path and style.

        ***********************************************************************/</span>

        <span class="d Constructor"><span class="k">this</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">path</span></span>, <span class="o Parameter"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">style</span> = <span class="e Identifier"><span class="i">ReadExisting</span></span></span>)</span>
        <span class="s FuncBody"><span class="s Compound">{
                <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">open</span></span> (<span class="i">path</span>, <span class="i">style</span>)</span>;</span>
        }</span></span></span>

        <span class="bc">/***********************************************************************
        
                Create a FileConduit with the provided path and style.

                Deprecated: use char[] ctor instead

        ***********************************************************************/</span>

        <span class="d StorageClass"><span class="k">deprecated</span> <span class="d Constructor"><span class="k">this</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Identifier"><span class="i">PathView</span></span> <span class="i">path</span></span>, <span class="o Parameter"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">style</span> = <span class="e Identifier"><span class="i">ReadExisting</span></span></span>)</span>
        <span class="s FuncBody"><span class="s Compound">{
                <span class="s Expression"><span class="e Call"><span class="e This"><span class="k">this</span></span> (<span class="i">path</span>.<span class="i">toString</span>, <span class="i">style</span>)</span>;</span>
        }</span></span></span></span>    

        <span class="bc">/***********************************************************************
        
                Return the PathView used by this file.

                We're removing PathView here, in favour of toString()

        ***********************************************************************/</span>

        <span class="d StorageClass"><span class="k">deprecated</span> <span class="d Function"><span class="t Identifier"><span class="i">PathView</span></span> <span class="i">path</span> <span class="o Parameters">()</span>
        <span class="s FuncBody"><span class="s Compound">{
                <span class="lc">// return something useful in the interim</span>
                <span class="s Return"><span class="k">return</span> <span class="e New"><span class="k">new</span> <span class="t Identifier"><span class="i">FilePath</span></span> (<span class="e Identifier"><span class="i">path_</span></span>)</span>;</span>
        }</span></span></span></span>               

        <span class="bc">/***********************************************************************
        
                Return the Style used for this file.

        ***********************************************************************/</span>

        <span class="d Function"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">style</span> <span class="o Parameters">()</span>
        <span class="s FuncBody"><span class="s Compound">{
                <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">style_</span></span>;</span>
        }</span></span></span>               

        <span class="bc">/***********************************************************************
        
                Return the name of the FilePath used by this file.

        ***********************************************************************/</span>

        <span class="d StorageClass"><span class="k">override</span> <span class="d Function"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">toString</span> <span class="o Parameters">()</span>
        <span class="s FuncBody"><span class="s Compound">{
                <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">path_</span></span>;</span>
        }</span></span></span></span>               

        <span class="bc">/***********************************************************************
                
                Return the current file position.
                
        ***********************************************************************/</span>

        <span class="d Function"><span class="t Integral"><span class="k">long</span></span> <span class="i">position</span> <span class="o Parameters">()</span>
        <span class="s FuncBody"><span class="s Compound">{
                <span class="s Return"><span class="k">return</span> <span class="e Call"><span class="e Identifier"><span class="i">seek</span></span> (<span class="n">0</span>, <span class="i">Seek</span>.<span class="i">Anchor</span>.<span class="i">Current</span>)</span>;</span>
        }</span></span></span>               

        <span class="bc">/***********************************************************************
        
                Return the total length of this file.

        ***********************************************************************/</span>

        <span class="d Function"><span class="t Integral"><span class="k">long</span></span> <span class="i">length</span> <span class="o Parameters">()</span>
        <span class="s FuncBody"><span class="s Compound">{
                <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">long</span></span>    <span class="i">pos</span>,    
                        <span class="i">ret</span>;</span></span>
                        
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">pos</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">position</span></span> ()</span></span>;</span>
                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">ret</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">seek</span></span> (<span class="n">0</span>, <span class="i">Seek</span>.<span class="i">Anchor</span>.<span class="i">End</span>)</span></span>;</span>
                <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">seek</span></span> (<span class="i">pos</span>)</span>;</span>
                <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">ret</span></span>;</span>
        }</span></span></span>               


        <span class="bc">/***********************************************************************

                Windows-specific code
        
        ***********************************************************************/</span>

        <span class="d Version"><span class="k">version</span>(<span class="i">Win32</span>)
        <span class="d Compound">{
                <span class="d Protection"><span class="k">private</span> <span class="d Variables"><span class="t Integral"><span class="k">bool</span></span> <span class="i">appending</span>;</span></span>

                <span class="bc">/***************************************************************

                        Open a file with the provided style.

                ***************************************************************/</span>

                <span class="d Function"><span class="t Integral"><span class="k">void</span></span> <span class="i">open</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">path</span></span>, <span class="o Parameter"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">style</span> = <span class="e Identifier"><span class="i">ReadExisting</span></span></span>)</span>
                <span class="s FuncBody"><span class="s Compound">{
                        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">DWORD</span></span>   <span class="i">attr</span>,
                                <span class="i">share</span>,
                                <span class="i">access</span>,
                                <span class="i">create</span>;</span></span>

                        <span class="s Declaration"><span class="d Alias"><span class="k">alias</span> <span class="d Variables"><span class="t Identifier"><span class="i">DWORD</span></span><span class="t Array">[]</span> <span class="i">Flags</span>;</span></span></span>

                        <span class="d StorageClass"><span class="k">static</span> <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Flags</span></span> <span class="i">Access</span> =  
                                        <span class="e ArrayInit">[
                                        <span class="e Int"><span class="n">0</span></span>,                      <span class="lc">// invalid</span>
                                        <span class="e Identifier"><span class="i">GENERIC_READ</span></span>,
                                        <span class="e Identifier"><span class="i">GENERIC_WRITE</span></span>,
                                        <span class="e Or"><span class="e Identifier"><span class="i">GENERIC_READ</span></span> | <span class="e Identifier"><span class="i">GENERIC_WRITE</span></span></span>,
                                        ]</span>;</span></span></span>
                                                
                        <span class="d StorageClass"><span class="k">static</span> <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Flags</span></span> <span class="i">Create</span> =  
                                        <span class="e ArrayInit">[
                                        <span class="e Identifier"><span class="i">OPEN_EXISTING</span></span>,          <span class="lc">// must exist</span>
                                        <span class="e Identifier"><span class="i">CREATE_ALWAYS</span></span>,          <span class="lc">// truncate always</span>
                                        <span class="e Identifier"><span class="i">OPEN_ALWAYS</span></span>,            <span class="lc">// create if needed</span>
                                        <span class="e Identifier"><span class="i">OPEN_ALWAYS</span></span>,            <span class="lc">// (for appending)</span>
                                        ]</span>;</span></span></span>
                                                
                        <span class="d StorageClass"><span class="k">static</span> <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Flags</span></span> <span class="i">Share</span> =   
                                        <span class="e ArrayInit">[
                                        <span class="e Int"><span class="n">0</span></span>,
                                        <span class="e Identifier"><span class="i">FILE_SHARE_READ</span></span>,
                                        <span class="e Or"><span class="e Identifier"><span class="i">FILE_SHARE_READ</span></span> | <span class="e Identifier"><span class="i">FILE_SHARE_WRITE</span></span></span>,
                                        ]</span>;</span></span></span>
                                                
                        <span class="d StorageClass"><span class="k">static</span> <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Flags</span></span> <span class="i">Attr</span> =   
                                        <span class="e ArrayInit">[
                                        <span class="e Int"><span class="n">0</span></span>,
                                        <span class="e Identifier"><span class="i">FILE_FLAG_RANDOM_ACCESS</span></span>,
                                        <span class="e Identifier"><span class="i">FILE_FLAG_SEQUENTIAL_SCAN</span></span>,
                                        <span class="e Int"><span class="n">0</span></span>,
                                        <span class="e Identifier"><span class="i">FILE_FLAG_WRITE_THROUGH</span></span>,
                                        ]</span>;</span></span></span>

                        <span class="lc">// remember our settings</span>
                        <span class="s Expression"><span class="e Assert"><span class="k">assert</span>(<span class="e Identifier"><span class="i">path</span></span>)</span>;</span>
                        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">path_</span></span> = <span class="e Identifier"><span class="i">path</span></span></span>;</span>
                        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">style_</span></span> = <span class="e Identifier"><span class="i">style</span></span></span>;</span>

                        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">attr</span></span>   = <span class="e Index"><span class="e Identifier"><span class="i">Attr</span></span>[<span class="e Dot"><span class="e Identifier"><span class="i">style</span></span>.<span class="e Identifier"><span class="i">cache</span></span></span>]</span></span>;</span>
                        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">share</span></span>  = <span class="e Index"><span class="e Identifier"><span class="i">Share</span></span>[<span class="e Dot"><span class="e Identifier"><span class="i">style</span></span>.<span class="e Identifier"><span class="i">share</span></span></span>]</span></span>;</span>
                        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">create</span></span> = <span class="e Index"><span class="e Identifier"><span class="i">Create</span></span>[<span class="e Dot"><span class="e Identifier"><span class="i">style</span></span>.<span class="e Identifier"><span class="i">open</span></span></span>]</span></span>;</span>
                        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">access</span></span> = <span class="e Index"><span class="e Identifier"><span class="i">Access</span></span>[<span class="e Dot"><span class="e Identifier"><span class="i">style</span></span>.<span class="e Identifier"><span class="i">access</span></span></span>]</span></span>;</span>

                        <span class="lc">// zero terminate the path</span>
                        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[<span class="e Int"><span class="n">512</span></span>]</span> <span class="i">zero</span> = <span class="e VoidInit"><span class="k">void</span></span>;</span></span>
                        <span class="d StorageClass"><span class="k">auto</span> <span class="d Variables"><span class="i">name</span> = <span class="e Call"><span class="e Dot"><span class="e Identifier"><span class="i">stdc</span></span>.<span class="e Identifier"><span class="i">toStringz</span></span></span> (<span class="i">path</span>, <span class="i">zero</span>)</span>;</span></span>

                        <span class="s Version"><span class="k">version</span> (<span class="i">Win32SansUnicode</span>)
                                 <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">handle</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">CreateFileA</span></span> (<span class="i">name</span>, <span class="i">access</span>, <span class="i">share</span>, 
                                                       <span class="k">null</span>, <span class="i">create</span>, 
                                                       <span class="i">attr</span> | <span class="i">FILE_ATTRIBUTE_NORMAL</span>,
                                                       <span class="k">cast</span>(<span class="i">HANDLE</span>) <span class="k">null</span>)</span></span>;</span>
                             <span class="k">else</span>
                                <span class="s Compound">{
                                <span class="lc">// convert to utf16</span>
                                <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">wchar</span></span><span class="t Array">[<span class="e Int"><span class="n">512</span></span>]</span> <span class="i">convert</span> = <span class="e VoidInit"><span class="k">void</span></span>;</span></span>
                                <span class="d StorageClass"><span class="k">auto</span> <span class="d Variables"><span class="i">wide</span> = <span class="e Call"><span class="e Dot"><span class="e Identifier"><span class="i">Utf</span></span>.<span class="e Identifier"><span class="i">toString16</span></span></span> (<span class="i">name</span>[<span class="n">0</span>..<span class="i">path</span>.<span class="i">length</span>+<span class="n">1</span>], <span class="i">convert</span>)</span>;</span></span>

                                <span class="lc">// open the file</span>
                                <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">handle</span></span> = <span class="e Call"><span class="e Identifier"><span class="i">CreateFileW</span></span> (<span class="i">wide</span>.<span class="i">ptr</span>, <span class="i">access</span>, <span class="i">share</span>,
                                                      <span class="k">null</span>, <span class="i">create</span>, 
                                                      <span class="i">attr</span> | <span class="i">FILE_ATTRIBUTE_NORMAL</span>,
                                                      <span class="k">cast</span>(<span class="i">HANDLE</span>) <span class="k">null</span>)</span></span>;</span>
                                }</span></span>

                        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">handle</span></span> <span class="k">is</span> <span class="e Identifier"><span class="i">INVALID_HANDLE_VALUE</span></span></span>)
                            <span class="s Expression"><span class="e Identifier"><span class="i">error</span></span>;</span></span>

                        <span class="lc">// move to end of file?</span>
                        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Dot"><span class="e Identifier"><span class="i">style</span></span>.<span class="e Identifier"><span class="i">open</span></span></span> <span class="k">is</span> <span class="e Dot"><span class="e Identifier"><span class="i">Open</span></span>.<span class="e Identifier"><span class="i">Append</span></span></span></span>)
                            <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">appending</span></span> = <span class="e Bool"><span class="k">true</span></span></span>;</span></span>
                }</span></span></span>
                
                <span class="bc">/***************************************************************

                        Write a chunk of bytes to the file from the provided
                        array (typically that belonging to an IBuffer)

                ***************************************************************/</span>

                <span class="d StorageClass"><span class="k">override</span> <span class="d Function"><span class="t Integral"><span class="k">uint</span></span> <span class="i">write</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">void</span></span><span class="t Array">[]</span> <span class="i">src</span></span>)</span>
                <span class="s FuncBody"><span class="s Compound">{
                        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">DWORD</span></span> <span class="i">written</span>;</span></span>

                        <span class="lc">// try to emulate the Unix O_APPEND mode</span>
                        <span class="s If"><span class="k">if</span> (<span class="e Identifier"><span class="i">appending</span></span>)
                            <span class="s Expression"><span class="e Call"><span class="e Identifier"><span class="i">SetFilePointer</span></span> (<span class="i">handle</span>, <span class="n">0</span>, <span class="k">null</span>, <span class="i">Seek</span>.<span class="i">Anchor</span>.<span class="i">End</span>)</span>;</span></span>
                        
                        <span class="s Return"><span class="k">return</span> <span class="e Call"><span class="e Dot"><span class="e Super"><span class="k">super</span></span>.<span class="e Identifier"><span class="i">write</span></span></span> (<span class="i">src</span>)</span>;</span>
                }</span></span></span></span>
            
                <span class="bc">/***************************************************************

                        Set the file size to be that of the current seek 
                        position. The file must be writable for this to
                        succeed.

                ***************************************************************/</span>

                <span class="d Function"><span class="t Integral"><span class="k">void</span></span> <span class="i">truncate</span> <span class="o Parameters">()</span>
                <span class="s FuncBody"><span class="s Compound">{
                        <span class="lc">// must have Generic_Write access</span>
                        <span class="s If"><span class="k">if</span> (<span class="e Call"><span class="e Not">! <span class="e Identifier"><span class="i">SetEndOfFile</span></span></span> (<span class="i">handle</span>)</span>)
                              <span class="s Expression"><span class="e Identifier"><span class="i">error</span></span>;</span></span>                            
                }</span></span></span>               

                <span class="bc">/***************************************************************

                        Set the file seek position to the specified offset
                        from the given anchor. 

                ***************************************************************/</span>

                <span class="d Function"><span class="t Integral"><span class="k">long</span></span> <span class="i">seek</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">long</span></span> <span class="i">offset</span></span>, <span class="o Parameter"><span class="t Qualified"><span class="t Identifier"><span class="i">Seek</span></span>.<span class="t Identifier"><span class="i">Anchor</span></span></span> <span class="i">anchor</span> = <span class="e Dot"><span class="e Dot"><span class="e Identifier"><span class="i">Seek</span></span>.<span class="e Identifier"><span class="i">Anchor</span></span></span>.<span class="e Identifier"><span class="i">Begin</span></span></span></span>)</span>
                <span class="s FuncBody"><span class="s Compound">{
                        <span class="s Declaration"><span class="d Variables"><span class="t Identifier"><span class="i">LONG</span></span> <span class="i">high</span> = <span class="e Cast"><span class="k">cast</span>(<span class="t Identifier"><span class="i">LONG</span></span>) <span class="e Paren">(<span class="e RShift"><span class="e Identifier"><span class="i">offset</span></span> &gt;&gt; <span class="e Int"><span class="n">32</span></span></span>)</span></span>;</span></span>
                        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">long</span></span> <span class="i">result</span> = <span class="e Call"><span class="e Identifier"><span class="i">SetFilePointer</span></span> (<span class="i">handle</span>, <span class="k">cast</span>(<span class="i">LONG</span>) <span class="i">offset</span>, 
                                                      &amp;<span class="i">high</span>, <span class="i">anchor</span>)</span>;</span></span>

                        <span class="s If"><span class="k">if</span> (<span class="e AndAnd"><span class="e Identity"><span class="e Identifier"><span class="i">result</span></span> <span class="k">is</span> <span class="e Sign">-<span class="e Int"><span class="n">1</span></span></span></span> &amp;&amp; 
                            <span class="e Equal"><span class="e Call"><span class="e Identifier"><span class="i">GetLastError</span></span>()</span> != <span class="e Identifier"><span class="i">ERROR_SUCCESS</span></span></span></span>)
                            <span class="s Expression"><span class="e Identifier"><span class="i">error</span></span>;</span></span>

                        <span class="s Return"><span class="k">return</span> <span class="e Plus"><span class="e Identifier"><span class="i">result</span></span> + <span class="e Paren">(<span class="e LShift"><span class="e Cast"><span class="k">cast</span>(<span class="t Integral"><span class="k">long</span></span>) <span class="e Identifier"><span class="i">high</span></span></span> &lt;&lt; <span class="e Int"><span class="n">32</span></span></span>)</span></span>;</span>
                }</span></span></span>               
        }</span></span>


        <span class="bc">/***********************************************************************

                 Unix-specific code. Note that some methods are 32bit only
        
        ***********************************************************************/</span>

        <span class="d Version"><span class="k">version</span> (<span class="i">Posix</span>)
        <span class="d Compound">{
                <span class="bc">/***************************************************************

                        Open a file with the provided style.

                        Note that files default to no-sharing. That is, 
                        they are locked exclusively to the host process 
                        unless otherwise stipulated. We do this in order
                        to expose the same default behaviour as Win32

                        NO FILE LOCKING FOR BORKED POSIX

                ***************************************************************/</span>

                <span class="d Function"><span class="t Integral"><span class="k">void</span></span> <span class="i">open</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[]</span> <span class="i">path</span></span>, <span class="o Parameter"><span class="t Identifier"><span class="i">Style</span></span> <span class="i">style</span> = <span class="e Identifier"><span class="i">ReadExisting</span></span></span>)</span>
                <span class="s FuncBody"><span class="s Compound">{
                        <span class="s Declaration"><span class="d Alias"><span class="k">alias</span> <span class="d Variables"><span class="t Integral"><span class="k">int</span></span><span class="t Array">[]</span> <span class="i">Flags</span>;</span></span></span>

                        <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="i">O_LARGEFILE</span> = <span class="e Int"><span class="n">0x8000</span></span>;</span></span>

                        <span class="d StorageClass"><span class="k">static</span> <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Flags</span></span> <span class="i">Access</span> =  
                                        <span class="e ArrayInit">[
                                        <span class="e Int"><span class="n">0</span></span>,                      <span class="lc">// invalid</span>
                                        <span class="e Identifier"><span class="i">O_RDONLY</span></span>,
                                        <span class="e Identifier"><span class="i">O_WRONLY</span></span>,
                                        <span class="e Identifier"><span class="i">O_RDWR</span></span>,
                                        ]</span>;</span></span></span>
                                                
                        <span class="d StorageClass"><span class="k">static</span> <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Identifier"><span class="i">Flags</span></span> <span class="i">Create</span> =  
                                        <span class="e ArrayInit">[
                                        <span class="e Int"><span class="n">0</span></span>,                      <span class="lc">// open existing</span>
                                        <span class="e Or"><span class="e Identifier"><span class="i">O_CREAT</span></span> | <span class="e Identifier"><span class="i">O_TRUNC</span></span></span>,      <span class="lc">// truncate always</span>
                                        <span class="e Identifier"><span class="i">O_CREAT</span></span>,                <span class="lc">// create if needed</span>
                                        <span class="e Or"><span class="e Identifier"><span class="i">O_APPEND</span></span> | <span class="e Identifier"><span class="i">O_CREAT</span></span></span>,     <span class="lc">// append</span>
                                        ]</span>;</span></span></span>

                        <span class="d StorageClass"><span class="k">static</span> <span class="d StorageClass"><span class="k">const</span> <span class="d Variables"><span class="t Integral"><span class="k">short</span></span><span class="t Array">[]</span> <span class="i">Locks</span> =   
                                        <span class="e ArrayInit">[
                                        <span class="e Identifier"><span class="i">F_WRLCK</span></span>,                <span class="lc">// no sharing</span>
                                        <span class="e Identifier"><span class="i">F_RDLCK</span></span>,                <span class="lc">// shared read</span>
                                        ]</span>;</span></span></span>
                                                
                        <span class="lc">// remember our settings</span>
                        <span class="s Expression"><span class="e Assert"><span class="k">assert</span>(<span class="e Identifier"><span class="i">path</span></span>)</span>;</span>
                        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">path_</span></span> = <span class="e Identifier"><span class="i">path</span></span></span>;</span>
                        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">style_</span></span> = <span class="e Identifier"><span class="i">style</span></span></span>;</span>

                        <span class="lc">// zero terminate and convert to utf16</span>
                        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">char</span></span><span class="t Array">[<span class="e Int"><span class="n">512</span></span>]</span> <span class="i">zero</span> = <span class="e VoidInit"><span class="k">void</span></span>;</span></span>
                        <span class="d StorageClass"><span class="k">auto</span> <span class="d Variables"><span class="i">name</span> = <span class="e Call"><span class="e Dot"><span class="e Identifier"><span class="i">stdc</span></span>.<span class="e Identifier"><span class="i">toStringz</span></span></span> (<span class="i">path</span>, <span class="i">zero</span>)</span>;</span></span>
                        <span class="d StorageClass"><span class="k">auto</span> <span class="d Variables"><span class="i">mode</span> = <span class="e Or"><span class="e Index"><span class="e Identifier"><span class="i">Access</span></span>[<span class="e Dot"><span class="e Identifier"><span class="i">style</span></span>.<span class="e Identifier"><span class="i">access</span></span></span>]</span> | <span class="e Index"><span class="e Identifier"><span class="i">Create</span></span>[<span class="e Dot"><span class="e Identifier"><span class="i">style</span></span>.<span class="e Identifier"><span class="i">open</span></span></span>]</span></span>;</span></span>

                        <span class="lc">// always open as a large file</span>
                        <span class="s Expression"><span class="e Assign"><span class="e Identifier"><span class="i">handle</span></span> = <span class="e Call"><span class="e Dot"><span class="e Identifier"><span class="i">posix</span></span>.<span class="e Identifier"><span class="i">open</span></span></span> (<span class="i">name</span>, <span class="i">mode</span> | <span class="i">O_LARGEFILE</span>, <span class="n">0666</span>)</span></span>;</span>
                        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">handle</span></span> <span class="k">is</span> <span class="e Sign">-<span class="e Int"><span class="n">1</span></span></span></span>)
                            <span class="s Expression"><span class="e Identifier"><span class="i">error</span></span>;</span></span>
                }</span></span></span>

                <span class="bc">/***************************************************************

                        Set the file size to be that of the current seek 
                        position. The file must be writable for this to
                        succeed.

                ***************************************************************/</span>

                <span class="d Function"><span class="t Integral"><span class="k">void</span></span> <span class="i">truncate</span> <span class="o Parameters">()</span>
                <span class="s FuncBody"><span class="s Compound">{
                        <span class="lc">// set filesize to be current seek-position</span>
                        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Call"><span class="e Identifier"><span class="i">ftruncate</span></span> (<span class="i">handle</span>, <span class="k">cast</span>(<span class="k">int</span>) <span class="i">position</span>)</span> <span class="k">is</span> <span class="e Sign">-<span class="e Int"><span class="n">1</span></span></span></span>)
                            <span class="s Expression"><span class="e Identifier"><span class="i">error</span></span>;</span></span>
                }</span></span></span>               

                <span class="bc">/***************************************************************

                        Set the file seek position to the specified offset
                        from the given anchor. 

                ***************************************************************/</span>

                <span class="d Function"><span class="t Integral"><span class="k">long</span></span> <span class="i">seek</span> <span class="o Parameters">(<span class="o Parameter"><span class="t Integral"><span class="k">long</span></span> <span class="i">offset</span></span>, <span class="o Parameter"><span class="t Qualified"><span class="t Identifier"><span class="i">Seek</span></span>.<span class="t Identifier"><span class="i">Anchor</span></span></span> <span class="i">anchor</span> = <span class="e Dot"><span class="e Dot"><span class="e Identifier"><span class="i">Seek</span></span>.<span class="e Identifier"><span class="i">Anchor</span></span></span>.<span class="e Identifier"><span class="i">Begin</span></span></span></span>)</span>
                <span class="s FuncBody"><span class="s Compound">{
                        <span class="s Declaration"><span class="d Variables"><span class="t Integral"><span class="k">long</span></span> <span class="i">result</span> = <span class="e Call"><span class="e Dot"><span class="e Identifier"><span class="i">posix</span></span>.<span class="e Identifier"><span class="i">lseek</span></span></span> (<span class="i">handle</span>, <span class="k">cast</span>(<span class="k">int</span>) <span class="i">offset</span>, <span class="i">anchor</span>)</span>;</span></span>
                        <span class="s If"><span class="k">if</span> (<span class="e Identity"><span class="e Identifier"><span class="i">result</span></span> <span class="k">is</span> <span class="e Sign">-<span class="e Int"><span class="n">1</span></span></span></span>)
                            <span class="s Expression"><span class="e Identifier"><span class="i">error</span></span>;</span></span>
                        <span class="s Return"><span class="k">return</span> <span class="e Identifier"><span class="i">result</span></span>;</span>
                }</span></span></span>               
        }</span></span>
}</span></span></span>

</pre></td>
</tr></table>
</body>
</html>